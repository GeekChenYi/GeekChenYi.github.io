---
title: 小程序运行时
date: 2021-02-04 10:20:00
permalink: /pages/mini-base-04/
categories:
  - 《微信小程序》笔记
tags:
  -
---
# 小程序运行时

## 小程序的运行环境

微信小程序运行在多种平台上：
 * iOS（iPhone/iPad）微信客户端
 * Android 微信客户端
 * PC 微信客户端
 * Mac 微信客户端
 * 用于调试的微信开发者工具

各平台脚本执行环境以及用于渲染非原生组件的环境是各不相同的：

 * 在 `iOS` 上，小程序逻辑层js代码运行在 `JavaScriptCore` 中，视图层是由 `WKWebView` 来渲染的；

 * 在Android 上，小程序逻辑层js代码运行在 V8 中，视图层是由自研 XWeb 引擎基于 Mobile Chrome 内核来渲染的；

 * 在开发工具上，小程序逻辑层js代码运行在 NW.js 中，视图层是由 Chromium Webview 来渲染的。

 * 在 PC 上，小程序逻辑层 javascript 和视图层 javascript 都是用 Chrome 内核

 * 在 Mac 上，小程序逻辑层的 javascript 代码运行在 JavaScriptCore 中，视图层是由 WKWebView 来渲染的，与 iOS 一致

## 平台差异性

尽管各运行环境是十分相似的，但是还是有一些区别的：

* js语法和API支持不一致
* WXSS表现不一致，通过开启样式补全来规避大部分样式的问题。

## 小程序运行机制

### 前台/后台状态

小程序启动后，界面被展示给用户，此时小程序处于前台状态。

当用户点击右上角胶囊按钮关闭小程序，或者按了设备 Home 键离开微信时，小程序并没有完全终止运行，而是进入了后台状态，小程序还可以运行一小段时间。

当用户再次进入微信或再次打开小程序，小程序又会从后台进入前台。如果用户很久没有再次进入或系统资源紧张，小程序可能被销毁，即完全终止运行。

### 小程序启动

小程序启动可以分为两种情况，一种是冷启动，一种是热启动。

* 冷启动：如果用户首次打开，或小程序销毁后被用户再次打开，此时小程序需要重新加载启动，即冷启动。
* 热启动：如果用户已经打开过某小程序，然后在一定时间内再次打开该小程序，此时小程序并未被销毁，只是从后台状态进入前台状态，这个过程就是热启动。

## 小程序更新机制

### 未启动时更新

开发者在管理后台发布新版本的小程序之后，如果某个用户本地有小程序的历史版本，此时打开的可能还是旧版本，

微信客户端会有若干个时机去检查本地缓存的小程序有没有更新版本，如果有则会静默更新到新版本。

总体来说，开发者在后台发布新版本之后，无法立刻影响到所有现网用户，但最差情况下，也在发布之后 24 小时之内下发新版本信息到用户。用户下次打开时会先更新最新版本再打开。

### 启动时更新

小程序每次冷启动时，都会检查是否有更新版本，如果发现有新版本，将会异步下载新版本的代码包，并同时用客户端本地的包进行启动，即新版本的小程序需要等下一次冷启动才会应用上。

如果需要马上应用最新版本，可以使用 wx.getUpdateManager API 进行处理。

